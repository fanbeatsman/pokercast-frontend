<!--
Copyright (C) 2014 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html>
	<head>
		<!--
		<style type="text/css">
		body {
		overflow: hidden;
		}
		#playerConnectionLog {
		height: 400PX;
		width: 200PX;
		right: 0px;
		text-align: left;
		border: 10px solid silver;
		display: table-cell;
		color: #FFFFFF;
		background-color: #000000;
		font-weight: bold;
		font-family: Verdana, Geneva, sans-serif;
		font-size: 10px;
		}

		#consoleLog {
		height: 400PX;
		width: 200PX;
		right: 0px;
		text-align: right;
		border: 10px solid silver;
		display: table-cell;
		color: #FFFFFF;
		background-color: #000000;
		font-weight: bold;
		font-family: Verdana, Geneva, sans-serif;
		font-size: 10px;
		}
		#testing {
		height: 400PX;
		width: 200PX;
		right: 0px;
		text-align: center;
		border: 10px solid silver;
		display: table-cell;
		color: #FFFFFF;
		background-color: #000000;
		font-weight: bold;
		font-family: Verdana, Geneva, sans-serif;
		font-size: 10px;
		}
		</style> -->

		<title>PokerCast</title>

		<link href="css/poker.css" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- bootstrap -->

		<link href="css/bootstrap-fluid-adj.css" rel="stylesheet">
		<link href="css/bootstrap.min.css" rel="stylesheet"/>
		<link href="css/bootstrap-responsive.css" rel="stylesheet"/>
		<title>Sample Media Receiver</title>

		<!-- <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>

		<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/mediaplayer/0.7.0/media_player.js"></script>
		-->

	</head>
	<body>

		<!-- DEFAULT MESSAGE -->
		<!--
		<div id="playerConnectionLog">
		Game Log...
		</div>
		<div id="consoleLog">
		Console Log...
		</div>
		<div id="testing">
		testing Log...
		</div>
		-->

		<!--
		<div class="gallery packery">

		<div class="item"> <img src="{% static 'cards/Spades/AS.svg' %}" /></div>

		</div>
		-->
		<div class="container-fluid">
			<div class="row-fluid" >
				<div class="span3 p1">
					<div class="score1"></div>
				</div>
				<div class="span3 p2">
					<div class="score2"></div>
				</div>
				<div class="span3 p3">
					<div class="score3"></div>
				</div>
				<div class="span3 p4">
					<div class="score4"><img src="cards/logo.png" style=":50%;width:50%;float:right;"/>
					</div>
				</div>

			</div>
			<br>
			<br>
			<div class="row-fluid">
				<div class="span3"></div>
				<div class="span1 5-1" >

				</div>
				<div class="span1 5-2">

				</div>

				<div class="span1 1-1" class="1"></div>
				<div class="span1 1-2" class="1"></div>

				<div class="span1" ></div>

			</div>

			<div class="row-fluid">

				<div class="span1 3-1" class="3">

				</div>
				<div class="span1 3-2" class="3">

				</div>

				<div class="span1"></div>
				<div class="span1 field">
					<div class="item">
						<div class="flip-container c1 big" ontouchstart="this.classList.toggle('hover');">
							<div class="flipper big">
								<div class="front big">
									<!-- front content -->

								</div>
								<div class="back big">
									<img src="cards/cardback.png" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="span1 field">
					<div class="item">
						<div class="flip-container c2 big" ontouchstart="this.classList.toggle('hover');">
							<div class="flipper big">
								<div class="front big">
									<!-- front content -->

								</div>
								<div class="back big">
									<img src="cards/cardback.png" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="span1 field">
					<div class="item">
						<div class="flip-container c3 big" ontouchstart="this.classList.toggle('hover');">
							<div class="flipper big">
								<div class="front big">
									<!-- front content -->

								</div>
								<div class="back big">
									<img src="cards/cardback.png" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="span1 field">
					<div class="item">
						<div class="flip-container c4 big" ontouchstart="this.classList.toggle('hover');">
							<div class="flipper big">
								<div class="front big">
									<!-- front content -->

								</div>
								<div class="back big">
									<img src="cards/cardback.png" />
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="span1 field" >
					<div class="item">
						<div class="flip-container c5 big" ontouchstart="this.classList.toggle('hover');">
							<div class="flipper big">
								<div class="front big">
									<!-- front content -->

								</div>
								<div class="back big">
									<img src="cards/cardback.png" />
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="span1"></div>

				<div class="span1 4-1">

				</div>
				<div class="span1 4-2" >

				</div>
			</div>

			<div class="row-fluid">

				<div class="span3"></div>

				<div class="span1" >

				</div>

				<div class="span1"></div>
				<div class="span1 2-1" class="2"></div>
				<div class="span1 2-2" class="2"></div>
				<div class="span1 6-1" class="6"></div>
				<div class="span1 6-2" class="6"></div>

			</div>

			<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
			<script type="text/javascript" src="js/jquery.easing.1.3.js"></script><script src="js/poker.min.js"></script><script src="js/pokercast.js"></script>
			<script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
			<script type="text/javascript">
				var playersList = [];

				window.onload = function() {
					cast.receiver.logger.setLevelValue(0);
					window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
					console.log('Starting Receiver Manager');

					initializePokerTable();

					// handler for the 'ready' event
					castReceiverManager.onReady = function(event) {
						console.log('Received Ready event: ' + JSON.stringify(event.data));
						window.castReceiverManager.setApplicationState("Application status is ready...");
					};

					// handler for 'senderconnected' event
					castReceiverManager.onSenderConnected = function(event) {

						console.log('Received Sender Connected event: ' + event.data);
						console.log(window.castReceiverManager.getSender(event.data).userAgent);
						playersList[senderId] = null;

					};

					// handler for 'senderdisconnected' event
					castReceiverManager.onSenderDisconnected = function(event) {
						console.log('Received Sender Disconnected event: ' + event.data);

						// we want to remove the player from the player list if he disconnects
						for (var i = 0; i < playerList.length; i++) {
							if (playerList[i].senderId = event.senderId) {
								var tempPlayerListIndex = i;
							}
						}
						playerList.splice(tempPlayerListIndex, 1);

						if (window.castReceiverManager.getSenders().length == 0) {
							window.close();
						}
					};

					// handler for 'systemvolumechanged' event
					castReceiverManager.onSystemVolumeChanged = function(event) {
						console.log('Received System Volume Changed event: ' + event.data['level'] + ' ' + event.data['muted']);
					};

					// create a CastMessageBus to handle messages for a custom namespace
					window.messageBus = window.castReceiverManager.getCastMessageBus('urn:x-cast:com.google.cast.sample.helloworld');

					// handler for the CastMessageBus message event
					window.messageBus.onMessage = function(event) {

						//if the object from device is name
						if ("name" in (JSON.parse(event.data))) {
							//sends player information to server
							playersList[event.senderId] = JSON.parse(event.data).name;
							console.log(playersList);
						}

						if ("START" in (JSON.parse(event.data))) {
							//sends player information to server
							startGame();
						}

						if ("ACTION" in (JSON.parse(event.data))) {
							//sends player information to server
							sendActionToServer(event, playerMapping);
						}

						// display the message from the sender
						//displayText(event.data + " extra text ");
						// inform all senders on the CastMessageBus of the incoming message event
						// sender message listener will be invoked
						if (playersList.length > 1) {
							window.messageBus.send(playersList[0].senderId, "READY");
							getPlayers();
						}

					}
					// initialize the CastReceiverManager with an application status message
					window.castReceiverManager.start({
						statusText : "Application is starting"
					});
					console.log('Receiver Manager started');
				};

				// utility function to display the text message in the input field
				function displayText(text) {
					console.log(text);
					document.getElementById("message").innerHTML = text;
					window.castReceiverManager.setApplicationState(text + "hello2");
				};

				function displayPlayerConnection(playersListArray) {

					for (var i = 0; i < playersList.length; i++) {
						console.log(playerList[i]);
					}

				}

				function isPlayerAlreadyConnected(playersListArray, newSenderId) {
					var isConnected = false;
					for (var i = 0; i < playersListArray.length; i++) {

						if (playersListArray[i].senderId == newSenderId) {
							isConnected = true;
						}
					}
					return isConnected;
				}

				function initializePokerTable() {
					$.get('http://mickey.io:3000/api/tabledefault', function(data) {
					});
				}

				function addPlayerAndChipsToBackend(player_name, chips) {
					$.get('http://mickey.io:3000/api/addplayer/' + player_name + '/' + chips, function(data) {

					});
				}

				function getPlayers() {
					$.get('http://mickey.io:3000/api/players', function(data) {
					});
				}

				function getPlayerByName(player_name) {
					$.get('http://mickey.io:3000/api/player/' + player_name, function(data) {
					});
				}

				function startGame() {
					$.get('http://mickey.io:3000/api/startgame', function(data) {
					});
				}

				function makePlayerMove(player_name, move) {
					$.get('http://mickey.io:3000/api/player/' + player_name + '/' + move, function(data) {

					});
				}

				function makePlayerBet(player_name, move, amount) {
					$.get('http://mickey.io:3000/api/player/' + player_name + '/' + move + '/' + amount, function(data) {

					});
				}

				function newRound() {
					$.get('http://mickey.io:3000/api/newround', function(data) {

					});
				}

				function getWinner() {
					$.get('http://mickey.io:3000/api/winner', function(data) {

					});
				}

				function receiveConnectionFromDevice(event) {

					//works
					var playerName = (JSON.parse(event.data)).name;
					var playerDeviceId = event.senderId;
					//testingLog += "receiveConnectionFromDevice : " + playerName + ',' + playerDeviceId + '<br>';
					//document.getElementById("testing").innerHTML = testingLog; // WORKS

					//checks if the player is already connected or not
					if (isPlayerAlreadyConnected(playersList, playerDeviceId) == false) {

						//creates a new player with its name + deviceSenderId (the iphone that sent the signal)
						var newPlayer = {};
						newPlayer.name = playerName;
						newPlayer.senderId = playerDeviceId;

						//removes duplicates of undefined devices.
						if (newPlayer.senderId != 'undefined' && newPlayer.senderId != null && newPlayer.senderId != '') {

							//adds a player in a player list
							playersList.push(newPlayer);
							//testingLog += playersList.length;
							//document.getElementById("testing").innerHTML = testingLog; // WORKS

							//sends a request to the back end to store the player values
							addPlayerAndChipsToBackend(newPlayer.name, 1000);

						}

						displayPlayerConnection(playersList);
					}
					return playerList;

				}

				function sendActionToServer(event, playerListArray) {

					var playerAction = JSON.parse(event.data).action;
					var playerName = getAssociatedPlayerName(playerListArray, event.senderId);
					var betAmount = 0;

					if (playerAction == 'bet') {
						betAmount = JSON.parse(event.data).amount
						makePlayerBet(playerName, playerAction, betAmount);
					}

					return;
				}

				function getAssociatedPlayerName(playerListObjectArray, senderId) {
					for (var i = 0; i < playerListObjectArray.length; i++) {
						if (playerListObjectArray[i].senderId == senderId) {
							return playerListObjectArray[i].name;
						}
					}
					return '';
				}

				// $(function() {

				// 	var players = ["fan", "usmann"];
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/tabledefault/');
				// 	makeSetup(totalPlayers, players);
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/startgame/');
				// 	/*var request = CallAndUpdate('http://mickey.io:3000/api/tabledefault');
				// 	 var request = CallAndUpdate('http://mickey.io:3000/api/addplayer/fan/1000');
				// 	 var request = CallAndUpdate('http://mickey.io:3000/api/addplayer/usmann/1000');
				// 	 var request = CallAndUpdate('http://mickey.io:3000/api/startgame');
				// 	 */

				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/usmann/call');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/fan/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/usmann/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/fan/check');
				// 	console.log(CallAndUpdate('http://mickey.io:3000/api/player/usmann/check'));

				// 	while (playerNum < totalPlayers + 1) {
				// 		addPokerPlayer('AS', 'KH');
				// 	}
				// 	setInitScore(totalPlayers);
				// 	var tableCards = new Array();
				// 	CallAndUpdate('http://mickey.io:3000/api/player/fan/check', tableCards);
				// 	console.log("tablecards:" + tableCards[1]);
				// 	setTable(tableCards[0], tableCards[1], tableCards[2], tableCards[3], tableCards[4]);
				// 	$('.flip-container').toggleClass('hover');
				// 	$('.flip-container').toggleClass('hover');
				// 	$('#test').click(function() {
				// 		$('.flip-container').toggleClass('hover');
				// 	});

				// 	updateScore(2, 99);
				// 	console.log("WINNNERERER");
				// 	console.log(CallAndUpdate('http://mickey.io:3000/api/winner'));
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/usmann/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/fan/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/usmann/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/fan/check');
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/player/usmann/check');
				// 	var winner;
				// 	console.log("REAL iNNERNERN");
				// 	var request = CallAndUpdate('http://mickey.io:3000/api/winner');

				// });

			</script>

	</body>

</html>

